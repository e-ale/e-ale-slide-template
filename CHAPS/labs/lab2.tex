\section{Lab 2}

\begin{frame}
   {Using libiio utilities}

   libiio is a helper library that abstracts away some of the complications of the raw IIO userspace ABI.

   In Lab2, we will accomplish the following:
	\begin{itemize}
		\item
			Using libiio, discover all devices
		\item
			Using libiio, read the current position of the thumbwheel
	\end{itemize}
\end{frame}


\begin{frame}
   {Preparation}

	Install a newer version of the \textbf{libiio} and \textbf{libiio-utils} packages from sid:

	\begin{rawscriptsize}
	$ sudo apt update
	$ sudo apt install -t sid libiio libiio-utils
	\end{rawscriptsize}
\end{frame}

\begin{frame}
    {Find our ADC IIO devices}
	Example which devices the IIO subsystem has exported:
	\begin{rawscriptsize}
root@beaglebone:/# iio_info
		Library version: 0.16 (git tag: v0.16)
		Compiled with backends: local xml ip usb serial
		IIO context created with local backend.
		Backend version: 0.16 (git tag: v0.16)
		Backend description string: Linux beaglebone 4.14.71-ti-r80 #1 SMP PREEMPT Fri Oct 5 23:50:11 UTC 2018 armv7l
		IIO context has 1 attributes:
		        local,kernel: 4.14.71-ti-r80
		IIO context has 1 devices:
		        iio:device0: 44e0d000.tscadc:adc (buffer capable)
		                8 channels found:
		                        voltage0:  (input, index: 0, format: le:u12/16>>0)
		                        1 channel-specific attributes found:
	                                	attr  0: raw value: 4095
		                        voltage1:  (input, index: 1, format: le:u12/16>>0)
		                        1 channel-specific attributes found:
		                                attr  0: raw value: 3680
					voltage2:  (input, index: 2, format: le:u12/16>>0)
		                        1 channel-specific attributes found:
		                                attr  0: raw value: 3979
		.
		.
		.
	\end{rawscriptsize}
	We should be able to identify the ADC channel that represents AIN0
\end{frame}

\begin{frame}
    {Read the ADC channel 0 value with libiio}

	Using \textbf{44e0d000.tscadc:adc} and \textbf{voltage0} we can read the position the thumbwheel:
	Read the raw ADC channel 0 value:
	\begin{rawscriptsize}
		root@beaglebone:/# iio_attr -c 44e0d000.tscadc:adc voltage0
		dev '44e0d000.tscadc:adc', channel 'voltage0' (input), attr 'raw', value '4095'
	\end{rawscriptsize}

	or for terser output:
	\begin{rawscriptsize}
		root@beaglebone:~# iio_attr -c 44e0d000.tscadc:adc voltage0 | cut -d ' ' -f 9
		'4095'
	\end{rawscriptsize}

	Try turning the thumbwheel and reading the position again, what are the results?
\end{frame}

\begin{frame}
    {Read ADC values continuously}

	\begin{rawscriptsize}
#!/bin/bash
while [ 1 ]; do
	echo `iio_attr -c 44e0d000.tscadc:adc voltage0 | cut -d ' ' -f 9`
done
	\end{rawscriptsize}
\end{frame}
